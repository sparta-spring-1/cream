<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>PortOne V2 Payment Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.portone.io/v2/browser-sdk.js"></script>
    <style>
        .container { max-width: 600px; margin-top: 50px; }
        .result-box { background-color: #f8f9fa; padding: 15px; border-radius: 5px; margin-top: 20px; display: none; }
    </style>
</head>
<body>

<div class="container">
    <h2 class="mb-4">PortOne V2 결제 테스트 (Security OFF)</h2>
    
    <div class="mb-3">
        <label class="form-label" for="storeId">Store ID (PortOne V2)</label>
        <input class="form-control" id="storeId" placeholder="store-..." type="text" value="">
        <div class="form-text">포트원 관리자 콘솔에서 확인 가능한 Store ID를 입력하세요.</div>
    </div>

    <div class="mb-3">
        <label class="form-label" for="tradeId">Trade ID</label>
        <input class="form-control" id="tradeId" placeholder="1" type="number" value="1">
        <div class="form-text">결제를 진행할 거래(Trade) ID를 입력하세요.</div>
    </div>

    <div class="mb-3">
        <label class="form-label" for="channelKey">Channel Key (Optional)</label>
        <input class="form-control" id="channelKey" placeholder="channel-key-..." type="text" value="">
        <div class="form-text">특정 채널을 지정하려면 입력하세요.</div>
    </div>

    <button class="btn btn-primary w-100" id="btnPrepare">결제 준비 및 요청 (Prepare & Request)</button>

    <div class="result-box" id="resultBox">
        <h5>결과:</h5>
        <pre id="resultOutput"></pre>
    </div>
</div>

<script>
    const btnPrepare = document.getElementById('btnPrepare');
    const resultBox = document.getElementById('resultBox');
    const resultOutput = document.getElementById('resultOutput');

    // 페이지 로드 시 Config 조회
    window.addEventListener('DOMContentLoaded', async () => {
        try {
            const response = await fetch('/v1/payments/config');
            if (response.ok) {
                const config = await response.json();
                if (config.storeId) {
                    document.getElementById('storeId').value = config.storeId;
                    console.log("Store ID loaded:", config.storeId);
                }
                if (config.channelKey) {
                    document.getElementById('channelKey').value = config.channelKey;
                    console.log("Channel Key loaded:", config.channelKey);
                }
            }
        } catch (error) {
            console.error("Failed to load payment config:", error);
        }
    });

    btnPrepare.addEventListener('click', async () => {
        const storeId = document.getElementById('storeId').value;
        const tradeId = document.getElementById('tradeId').value;
        const channelKey = document.getElementById('channelKey').value;

        if (!storeId) {
            alert('Store ID를 입력해주세요.');
            return;
        }

        if (!tradeId) {
            alert('Trade ID를 입력해주세요.');
            return;
        }

        addLog("1. 결제 준비 요청 중... (POST /v1/payments/prepare)");
        
        try {
            const headers = {
                'Content-Type': 'application/json'
            };

            const response = await fetch('/v1/payments/prepare', {
                method: 'POST',
                headers: headers,
                body: JSON.stringify({ tradeId: Number(tradeId) })
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Server Error: ${response.status} - ${errorText}`);
            }

            const data = await response.json();
            addLog(`2. 결제 준비 완료: Payment ID = ${data.paymentId}, Amount = ${data.amount}`);

            addLog("3. PortOne 결제 창 호출 중...");
            
            const paymentRequest = {
                storeId: storeId,
                paymentId: data.paymentId,
                orderName: data.productName,
                totalAmount: data.amount,
                currency: "CURRENCY_KRW",
                payMethod: "CARD",
                customer: {
                    email: data.email,
                    fullName: data.customerName,
                    phoneNumber: data.customerPhoneNumber
                }
            };

            if (channelKey) {
                paymentRequest.channelKey = channelKey;
            }

            const paymentResponse = await PortOne.requestPayment(paymentRequest);

            if (paymentResponse.code != null) {
                addLog(`4. 결제 실패: [${paymentResponse.code}] ${paymentResponse.message}`);
                alert(`결제 실패: ${paymentResponse.message}`);
            } else {
                addLog(`4. 결제 성공! Payment ID: ${paymentResponse.paymentId}`);
                console.log(paymentResponse);
                alert(`결제 성공! Payment ID: ${paymentResponse.paymentId}`);
            }

        } catch (error) {
            console.error(error);
            addLog(`Error: ${error.message}`);
            alert(`오류 발생: ${error.message}`);
        }
    });

    function addLog(message) {
        resultBox.style.display = 'block';
        const timestamp = new Date().toLocaleTimeString();
        resultOutput.innerText += `[${timestamp}] ${message}\n`;
    }
</script>

</body>
</html>
